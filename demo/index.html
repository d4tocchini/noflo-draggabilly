<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>NoFlo-Draggabilly demo</title>
    <script src="../components/eventEmitter/EventEmitter.js"></script>
    <script src="../components/eventie/eventie.js"></script>
    <script src="../components/get-style-property/get-style-property.js"></script>
    <script src="../components/classie/classie.js"></script>
    <script src="../components/get-size/get-size.js"></script>
    <script src="../components/draggabilly/draggabilly.js"></script>
    <script src="../dist/draggabilly.js"></script>
    <style>
      body {
      
        background-color: hsl(230,10%,85%);
      }
      .area {
        width: 600px;
        height: 400px;
        background-color: hsl(220,10%,90%);
        border: 1px hsl(220,10%,95%) solid;
        box-shadow:           
          inset 0 1px 4px hsla(220,20%,20%,.4);
      }
      .draggable {
        -webkit-user-drag: element;
        cursor: move;
        width: 100px;
        height: 100px;
        border-radius: 50px;
        background-color:hsl(220,20%,20%);
        /*border: solid 3px hsl(220,20%,95%);*/
        box-shadow: 
                0 -1px 0px hsl(220,100%,100%),
                0 1px 1px hsla(220,20%,0%,.2),
                0 3px 8px hsla(220,20%,0%,.1);
      }
      .draggable.is-dragging {

        box-shadow: 
                0 -1px 0px hsl(220,100%,100%),
                0 1px 1px hsla(220,20%,0%,.1),
                0 8px 13px hsla(220,20%,0%,.2);
        
      }
      textarea {
        width: 596px;
        height: 400px;
        
        border: 1px hsl(220,10%,95%) solid;
      }

    </style>
  </head>
  <body>
    <div class="area">
      <img class="draggable" src="http://bergie.iki.fi/style/img/mdpi/bergie.jpg" >
    </div>
    <textarea id="graph">
    </textarea>
    <script>
    
    window.onload = function () {
      
      var noflo = require('noflo');
      var graph = new noflo.Graph('Movable image');

      // Which component to start with when loading components
      graph.baseDir = 'noflo-draggabilly';

      // Logging
      graph.addNode('Log', 'Output');
      graph.addNode('LogSplit', 'Split');
      
      // Container IIP must pass before image! 
      graph.addNode('Touch', 'draggabilly/Draggabilly');
      graph.addNode('Container', 'GetElement');
      graph.addInitial('.area', 'Container', 'selector'); 

      // The image element, selected from DOM with CSS selector
      graph.addNode('Image', 'GetElement');
      graph.addInitial('.area .draggable', 'Image', 'selector'); 
      graph.addNode('SendElement', 'Split');

      // Initial positioning for the image
      graph.addNode('AnchorX', 'Split');
      graph.addInitial(250, 'AnchorX', 'in');
      graph.addNode('AnchorY', 'Split');
      graph.addInitial(150, 'AnchorY', 'in');
      
      
      graph.addNode('DragX', 'Gate');
      graph.addNode('DragY', 'Gate');
      graph.addNode('NewX', 'Kick');
      graph.addNode('SpringX', 'Spring');
      graph.addNode('NewY', 'Kick');
      graph.addNode('SpringY', 'Spring');
      graph.addNode('PosX', 'Merge');
      graph.addNode('PosY', 'Merge');
      graph.addNode('Move', 'MoveElement');
      
      
      graph.addEdge('Container', 'element', 'Touch', 'container');
      // Pass the image element to nodes that need it      
      graph.addEdge('Image', 'element', 'SendElement', 'in');
      graph.addEdge('SendElement', 'out', 'Touch', 'element');
      graph.addEdge('SendElement', 'out', 'Move', 'element');

      // initial left-right positioning
      graph.addEdge('AnchorX', 'out', 'PosX', 'in');
      graph.addEdge('PosX', 'out', 'Move', 'x');      

      // initial up-down positioning
      graph.addEdge('AnchorY', 'out', 'PosY', 'in');
      graph.addEdge('PosY', 'out', 'Move', 'y');

      // left-right axis dragging
      graph.addEdge('Touch', 'start', 'DragX', 'open');
      //graph.addEdge('Touch', 'moveX', 'DragX', 'in'); // handled internally by Draggabilly
      graph.addEdge('Touch', 'end', 'DragX', 'close');
      graph.addEdge('DragX', 'out', 'PosX', 'in');

      // left-right axis return when touch ends
      graph.addEdge('AnchorX', 'out', 'SpringX', 'anchor');
      graph.addEdge('Touch', 'moveX', 'NewX', 'data');
      graph.addEdge('Touch', 'end', 'NewX', 'in');
      graph.addEdge('NewX', 'out', 'SpringX', 'in');
      graph.addEdge('SpringX', 'out', 'PosX', 'in');

      // up-down axis dragging
      graph.addEdge('Touch', 'start', 'DragY', 'open');
      //graph.addEdge('Touch', 'moveY', 'DragY', 'in'); // handled internally by Draggabilly
      graph.addEdge('Touch', 'end', 'DragY', 'close');
      graph.addEdge('DragY', 'out', 'PosY', 'in');

      // up-down axis return when touch ends
      graph.addEdge('AnchorY', 'out', 'SpringY', 'anchor');
      graph.addEdge('Touch', 'moveY', 'NewY', 'data');
      graph.addEdge('Touch', 'end', 'NewY', 'in');
      graph.addEdge('NewY', 'out', 'SpringY', 'in');
      graph.addEdge('SpringY', 'out', 'PosY', 'in');

      // write graph JSON to textarea
      var g = document.getElementById('graph');
      g.value = JSON.stringify(graph.toJSON(), null, 2);
      
      // run the graph
      noflo.createNetwork(graph, function (network) {
        console.log("Network created");
      });
    };
    </script>
  </body>
</html>
